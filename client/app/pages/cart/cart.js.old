app.controller("cartController", ["$scope", "$http", "$routeParams", "$location", "svgToJpg", "$rootScope", "$sce", "Site",
function($scope, $http, $routeParams, $location, svgToJpg, $rootScope, $sce, $site) {

  $scope.cart = {};
  $scope.cartItems = [];
  $scope.shipping = undefined;
  $scope.total = null;
  $scope.salesTax = 0;

  $scope.shipZip = null;
  $scope.shippingIsLoading = false;

  $scope.loadCart = function() {
    var cartStr = localStorage.getItem('cart');
    if (cartStr) {
      $scope.cart = JSON.parse(cartStr);
      $scope.cartItems = [];
      $scope.cart.items.forEach(function(itemGuid) {
        var itemStr = localStorage.getItem('item' + itemGuid);
        if (itemStr) {
          $scope.cartItems.push(JSON.parse(itemStr));
        }
      });

      $scope.loadShippingQuote();
      $scope.calculateCart();
    }
  }

  $rootScope.$on("processingImage", function(event, dataString) {
    var data = JSON.parse(dataString);

    var item = $scope.cartItems.find(function(item) {
      return item.guid == data.guid;
    });

    if (item) {
      if (data.message == 'uploading') {
        item.status = 'Uploading artwork to print server';
      }
      else if (data.message == 'done') {
        item.isUploaded = true;
        item.status = undefined;
        localStorage.setItem('item' + data.guid, JSON.stringify(item));
        $scope.loadCart();
      }
    }
  });

  $scope.catchEnter = function($event) {
    if ($event.keyCode == 13) {
      $scope.applyDiscountCode();
    }
  }

  $scope.applyDiscountCode = function() {
    $http.post(API_URL + "/Cart/validate_discount_code", {
      discountCode: $scope.newDiscountCode
    }).then(function(response) {
      if (response.data.results) {
        if (response.data.results.freeShipping) {
          $scope.freeShipping = true;
        }
        if (response.data.results.pctDiscount) {
          $scope.pctDiscount = Number(response.data.results.pctDiscount);
        }
        $scope.discountCode = response.data.results.discountCode;
        $scope.discountDescription = response.data.results.discountDescription;
        $scope.newDiscountCode = null;
        $scope.calculateCart();
      }
      else {
        $site.displayNotification("Invalid discount code");
      }
    }, function(error) {
      console.error(error);
    });
  }

  $scope.getCartItemThumbnail = function(item) {
    if (item.isUploaded) {
      return $sce.trustAsHtml(item.svg);
    }
    else {
      return 'assets/images/no-image.png';
    }
  }

  $scope.calculateCart = function() {
    $scope.subtotal = $scope.cartItems.reduce(function(runningTotal, current) {
      return Number(runningTotal) + (current.qty * current.price);
    }, 0);
    if ($scope.freeShipping) {
      $scope.shipping = 0;
    }
    if ($scope.pctDiscount) {
      $scope.discount = -$scope.pctDiscount * $scope.subtotal;
    }
    $scope.total = Number($scope.subtotal);
    if ($scope.shipping) {
      $scope.total +=  Number($scope.shipping);
    }
    if ($scope.discount) {
      $scope.total += Number($scope.discount);
    }
    if ($scope.salesTax) {
      $scope.total += Number($scope.salesTax);
    }
    console.log($scope.total);
  }

  $scope.updateQuantity = function(item) {
    localStorage.setItem('item' + item.guid, JSON.stringify(item));
    $scope.loadShippingQuote();
  }

  $scope.loadShippingQuote = function() {
    if ($scope.freeShipping || !$scope.shipZip) {
      $scope.calculateCart();
      return;
    }
    var externalItems = [];
    $scope.cartItems.forEach(function(item) {
      var extItem = externalItems.find(function(i) {
        return i.sku == item.sku;
      });
      if (extItem) {
        extItem.qty += 1;
      }
      else {
        externalItems.push({
          'sku': item.externalId,
          'qty': item.qty
        });
      }
    });

    $scope.shippingIsLoading = true;
    $http.post(API_URL + "/Cart/get_shipping_quote", {
      address: {
        postalCode: $scope.shipZip,
        country: 'US'
      },
      items: externalItems
    }).then(function(response) {
      $scope.shippingIsLoading = false;
      if (!$scope.freeShipping) {
        $scope.shipping = response.data.results.shipping;
      }
      $scope.calculateCart();
    }, function(error) {
      $scope.shippingIsLoading = false;
      console.error(error);
    });
  }

  $scope.toggleRemoveItemConfirmation = function(item) {
    item.isRemoveItemConfirmationDisplayed = item.isRemoveItemConfirmationDisplayed ? false : true;
  }

  $scope.removeItem = function(item) {
    $scope.toggleRemoveItemConfirmation(item);
    localStorage.removeItem('item' + item.guid);
    $scope.loadCart();
  }

  $scope.removeDiscountCode = function() {
    $scope.resetDiscount();
    $scope.calculateCart();
  }

  $scope.resetDiscount = function() {
    $scope.discountCode = undefined;
    $scope.newDiscountCode = undefined;
    $scope.discount = 0;
    $scope.pctDiscount = 0;
  }

  $scope.continueCheckout = function() {
    if ($site.isSignedIn) {
      $location.path('shipping');
    }
    else {
      $location.path('signin').search('redir', 'shipping');
    }
  }



  $scope.loadCart();
}]);
